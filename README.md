# ah-processor.utils

Utilities used by the ah-\*.processor modules.

## Installation

    npm install ah-processor.utils

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

-   [API](#api)
    -   [idsTriggeredBy](#idstriggeredby)
    -   [oldestId](#oldestid)
    -   [immediatelyBeforeId](#immediatelybeforeid)
    -   [prettyNs](#prettyns)
    -   [safeGetVal](#safegetval)
    -   [safeFirstStamp](#safefirststamp)
    -   [uniqueUserFunctions](#uniqueuserfunctions)
    -   [separateUserFunctions](#separateuserfunctions)
    -   [mergeUserFunctions](#mergeuserfunctions)
-   [License](#license)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## [API](https://nodesource.github.io/ah-processor.utils)

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### idsTriggeredBy

Finds all ids of activities that are triggered by the given id.
This function works recursive, i.e. any activity triggered by
a child of the root activity is included as well.

For this to work, activities are assumed to be in the order that
they were triggered. This can easily be achieved by simply sorting
the activities by their init timestamp.

**Parameters**

-   `activities` **[Map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map)&lt;[number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number), Activity>** collected via [ah-fs](https://github.com/nodesource/ah-fs)
-   `id` **[number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number)** the id of the root activity we whose triggered _children_ we are trying to find
-   `stop` **[function](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function)** a predicate that will finish the activity walk if it returns `true`.
     Function signature: `(id, activity)`.

Returns **[Set](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set)&lt;[number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number)>** the provided root id and all ids of activities triggered by it or any of it's children,
grandchildren, etc.

### oldestId

Finds the oldest activity of the ones supplied via the ids.
We consider an activity older than another one if it's init timestamp
is further in the past.

Any ids we can't find as in the activities are ignored.

**Parameters**

-   `activities` **[Map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map)&lt;[Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number), [Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)>** the collected async activities
-   `ids` **[Set](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set)&lt;[Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number)>** the ids to consider when finding the oldest

Returns **[Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number)** the id of the oldest activity or `null` if no activity for any id was found

### immediatelyBeforeId

Finds the activity of the ones supplied via the ids that initialized immediately
before the one with the given id initialized.

**Parameters**

-   `activities` **[Map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map)&lt;[Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number), [Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)>** the collected async activities
-   `ids` **[Set](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set)&lt;[Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number)>** the ids to consider when finding most immediate
-   `the` **[Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number)** id of the activity for which we will find the activity that initialized immediately before

Returns **[Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number)** the id that initialized immediately before the activity with `id` or `null` if no activity for any
id was found

### prettyNs

Prettifies the provided timestamp which is expected to be in nanoseconds.

**Parameters**

-   `ns` **[number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number)** timestamp in nanoseconds

Returns **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)&lt;[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String), [number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number)>** an object with an `ms` property which is the prettified version
of the provided timestamp in milliseconds and `ns`, the originally passed timestamp.

### safeGetVal

Safely extracts the `val` property from the object `x`.

**Parameters**

-   `x` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** the object which has the `val` property

Returns **any** the `val` property if `x` was defined, otherwise `null`

### safeFirstStamp

Safely gets the first time stamp of the given timestamps.
If no timestamp is found, a time of `0` is returned.

**Parameters**

-   `x` **[Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[Number](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number)>** the timestamps

Returns **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** the prettified first time stamp

### uniqueUserFunctions

Identifies all user functions within the given functions, adds location and
propertyPath strings and returns the result.

The `propertyPath` is deduced from the `path` array.

If a user function is found twice it will only be included once.

**Parameters**

-   `fns` **[Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)>** all functions found attached to a particular async resource
-   `$0` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** options
    -   `$0.pathPrefix` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)?** prefix used for the property paths (optional, default `'root'`)

Returns **[Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)>** all user functions with the above mentioned details added

### separateUserFunctions

Pulls user functions from all resources of the provided info and attaches
them as the `userFunctions` property to the info object directly.

As a result, instead of having a `userFunctions` array on each resource
we end up with just one on the info object.

**Parameters**

-   `info` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** the info object which references the resources

### mergeUserFunctions

Merges the `userFunctions` found on the `info` object, such that all functions
with the same `location` property are represented as one.

As the result the `propertyPath` array is removed from all functions and replaced
with the `propertyPaths` array which combines the `propertyPath`s of all functions
that matched the `location`.

**Parameters**

-   `info` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** the object that references the `userFunctions` property

## License

MIT
